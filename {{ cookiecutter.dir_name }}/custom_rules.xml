<?xml version="1.0" encoding="UTF-8"?>
<project name="{{ cookiecutter.app_name }}-custom">

    <!-- Check to see if the Python payload has been modified -->
    <target name="-python-payload-modified">
        <uptodate property="python-payload.nochange" targetfile="assets/python-payload.tgz" >
            <srcfiles dir="python" includes="**/*"/>
        </uptodate>
    </target>

    <!-- Check to see if the App Packages payload has been modified -->
    <target name="-app_packages-payload-modified">
        <uptodate property="app_packages-payload.nochange" targetfile="assets/app_packages-payload.tgz" >
            <srcfiles dir="app_packages" includes="**/*"/>
        </uptodate>
    </target>

    <!-- Check to see if the App payload has been modified -->
    <target name="-app-payload-modified">
        <uptodate property="app-payload.nochange" targetfile="assets/app-payload.tgz" >
            <srcfiles dir="app" includes="**/*"/>
        </uptodate>
    </target>

    <!-- Rebuild the Python payload blob -->
    <target name="-python-payload-build" depends="-python-payload-modified" unless="python-payload.nochange">

        <tar destfile="assets/python-payload.tgz"
            basedir="."
            compression="gzip"
            includes="python/**/*"
            excludes="python/**/*.pyc"
        />

        <replaceregexp file="res/values/strings.xml"
               match='(&lt;string name="python_payload_timestamp"&gt;)(.*?)(&lt;/string&gt;)'
               replace="\1${MODIFIED}\3"
               byline="true"
        />
    </target>

    <!-- Rebuild the App Packages payload blob -->
    <target name="-app_packages-payload-build" depends="-app_packages-payload-modified" unless="app_packages-payload.nochange">

        <tar destfile="assets/app_packages-payload.tgz"
            basedir="."
            compression="gzip"
            includes="app_packages/**/*"
            excludes="app_packages/**/*.pyc"
        />

        <replaceregexp file="res/values/strings.xml"
               match='(&lt;string name="app_packages_payload_timestamp"&gt;)(.*?)(&lt;/string&gt;)'
               replace="\1${MODIFIED}\3"
               byline="true"
        />
    </target>

    <!-- Rebuild the App payload blob -->
    <target name="-app-payload-build" depends="-app-payload-modified" unless="app-payload.nochange">

        <tar destfile="assets/app-payload.tgz"
            basedir="."
            compression="gzip"
            includes="app/**/*"
            excludes="app/**/*.pyc"
        />

        <replaceregexp file="res/values/strings.xml"
               match='(&lt;string name="app_payload_timestamp"&gt;)(.*?)(&lt;/string&gt;)'
               replace="\1${MODIFIED}\3"
               byline="true"
        />
    </target>

    <target name="-pre-build">
        <tstamp>
            <format property="MODIFIED" pattern="YYYYMMddHHmmss" />
        </tstamp>

        <!-- Rebuild the payload blob -->
        <antcall target="-python-payload-build" />
        <antcall target="-app_packages-payload-build" />
        <antcall target="-app-payload-build" />
    </target>
</project>
